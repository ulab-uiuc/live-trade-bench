# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Live Trade Bench is a trading evaluation platform that integrates AI-powered trading models with real market data across stocks, prediction markets (Polymarket), and social sentiment. The system consists of a core Python library (`trading_bench`), FastAPI backend, and React TypeScript frontend.

## Trading Competition Architecture

### Core Workflow - Agent-Based Trading System

**Portfolio Management:**
- Stock agents start with $1,000 initial capital
- Polymarket agents start with $500 initial capital
- Each agent maintains separate account: {cash: $X, holdings: {AAPL: Y shares, NVDA: Z shares, ...}}
- Agents compete against each other to compare LLM performance across different strategies
- Stock universe is dynamically determined by `fetch_trending_stocks()` function (typically 10-12 major stocks)

**Portfolio Allocation Trading Process:**
1. **Market Hours Check**: Stock trading only occurs during weekdays and market hours (9:30 AM - 4:00 PM ET)
2. **Portfolio Analysis**: Agent analyzes entire universe at once, considering current portfolio allocations and market context
3. **LLM Portfolio Decision**: Agent prepares comprehensive analysis and calls LLM with portfolio-wide prompts for allocation decisions
4. **Allocation Generation**: LLM returns target portfolio allocation percentages with confidence scores
   - **Stock allocations**: AAPL: 15%, NVDA: 25%, cash: 10% (confidence-weighted)
   - **Polymarket allocations**: Market-specific percentage allocations with outcome predictions
5. **Rebalancing Execution**: Account system calculates required trades and executes multiple buy/sell orders to achieve target allocations
6. **Performance Tracking**: Account evaluation provides portfolio summaries with allocation percentages, return metrics, and P&L
7. **History Management**: Rolling price history maintained per asset (max 10 entries) for trend analysis

**Portfolio Action Types:**
- **REBALANCE**: Adjust portfolio to target allocation percentages across all assets
- **HOLD**: Maintain current portfolio allocations unchanged
- **Target allocations**: Specify desired percentage holdings with confidence scores
  - Stock: {AAPL: 0.15, NVDA: 0.25, MSFT: 0.20} with confidence levels
  - Polymarket: {market_id: allocation_pct} with outcome predictions

**Data Sources:**
- **Backtesting**: Uses end-of-day historical data for evaluation
- **Real-time**: Fetchers provide current market sentiment and news

**Logging Structure:**
- **System Logs**: ONLY trading actions generated by agents (tracked via backend/app/trading_actions.py)
- **Trading History**: Historical P&L records after action execution with performance metrics

## Development Commands

### Backend (FastAPI)
```bash
cd backend
python run.py                    # Start development server on port 8000
python -m uvicorn app.main:app --reload --port 8000  # Alternative start method
```

### Frontend (React TypeScript)
```bash
cd frontend
npm install                      # Install dependencies
npm start                        # Start development server on port 3000
npm run build                    # Build for production
```

### Testing and Quality
```bash
pytest tests/                        # Run test suite
python examples/fetcher_demo.py      # Comprehensive fetcher examples
python examples/stock_demo.py        # Stock-specific demo
python examples/reddit_demo.py       # Social sentiment demo
python examples/polymarket_demo.py   # Prediction market demo
```

### Dependencies
```bash
poetry install                   # Install Python dependencies
poetry add <package>            # Add new Python dependency
```

## Core Architecture

### Three-Layer System
1. **`trading_bench/`** - Core Python library with fetchers, agents, and account management
2. **`backend/`** - FastAPI REST API that exposes trading_bench functionality
3. **`frontend/`** - React dashboard for visualization and interaction

### Data Flow Pattern
```
External APIs → Fetchers → AI Agents → Account System → Backend API → Frontend
```

### Key Integration Points

**Real vs Sample Data**: The system has dual data modes:
- **Development**: Uses sample data from `backend/app/data.py`
- **Production**: Calls real fetchers from trading_bench library
- **Fallback**: Gracefully degrades to sample data if external APIs fail

**FastAPI ↔ trading_bench**: Backend directly imports and calls library functions. Path setup in data.py adds trading_bench to sys.path for imports.

**LLM Integration**: Trading agents use `trading_bench/utils/llm_client.py` for AI-powered decision making. Requires OpenAI API key via environment variable `OPENAI_API_KEY`.

## Core Components

### Fetchers (`trading_bench/fetchers/`)
All inherit from `BaseFetcher` with retry logic and rate limiting:
- **StockFetcher**: Yahoo Finance data via yfinance
- **NewsFetcher**: Google News scraping with BeautifulSoup
- **RedditFetcher**: Social sentiment via PRAW (requires Reddit API credentials)
- **PolymarketFetcher**: Prediction market data

### Agents (`trading_bench/agents/`)
All inherit from unified BaseAgent class with simplified, symmetric architecture:
- **BaseAgent**: Unified base class with LLM integration, price gating, history tracking, and domain hooks
- **LLMStockAgent**: Stock market trading using BaseAgent with stock-specific hooks
- **LLMPolyMarketAgent**: Prediction market trading using BaseAgent with polymarket-specific hooks
- **StockTradingSystem**: Complete stock trading system with portfolio management
- **PolymarketTradingSystem**: Complete polymarket trading system with portfolio management

### Accounts (`trading_bench/accounts/`)
Account management system for portfolio tracking:
- **BaseAccount**: Core account functionality with portfolio management and rebalancing
- **StockAccount**: Stock-specific account with position tracking and allocation management
- **PolymarketAccount**: Prediction market account management with outcome tracking
- **Action**: Trading action definitions (BUY/SELL/HOLD/REBALANCE)
- **Utils**: Account utilities and helper functions
- **PortfolioModels**: Portfolio data models for allocation targets, rebalance plans, and summaries

### Backend Structure (`backend/app/`)
- **`main.py`**: FastAPI app with CORS and request logging middleware
- **`routers/`**: Separate modules for models, trades, news, social, system_logs
- **`data.py`**: Real data functions that call trading_bench + sample data fallbacks
- **`schemas.py`**: Pydantic models for API responses
- **`trading_system.py`**: Multi-asset trading system using native TradingSystem.run() and PolymarketTradingSystem.run() methods
- **`trading_actions.py`**: Trading action management and logging system

## Important Implementation Details

### Agent Architecture Changes
- **Unified BaseAgent**: All agents now inherit from a single BaseAgent class with shared functionality and portfolio management
- **Portfolio-Wide Analysis**: Agents analyze entire universe simultaneously instead of individual assets
- **Domain Hooks**: Subclasses implement specific hooks for portfolio data extraction, analysis preparation, and allocation action creation
- **Portfolio-Level LLM Integration**: Built-in LLM calling with portfolio-wide JSON prompts for allocation decisions with confidence scoring
- **History Tracking**: Automatic price history management with configurable limits for all assets
- **Rebalancing Logic**: Accounts automatically calculate and execute trades to achieve target portfolio allocations
- **Performance Evaluation**: Portfolio-level metrics including return percentages, P&L, and allocation analysis

### Real Data Requirements
- **Stock data**: No API key needed (uses yfinance)
- **News data**: No API key needed (scrapes Google News)
- **Reddit data**: Requires PRAW credentials in environment variables
- **AI trading**: Requires OpenAI API key in `OPENAI_API_KEY`

### PRAW Async Warnings
The Reddit fetcher uses PRAW in FastAPI (async environment) which generates harmless warnings. These are suppressed in `get_real_social_data()` function.

### Error Handling Philosophy
The system follows "ONLY REAL DATA" principle:
- When external APIs fail, return empty results rather than fake data
- Sample data is only used during development, never as fallback in production
- All endpoints gracefully handle missing API credentials

### Account Management Logic
Account system maintains portfolio allocations with comprehensive rebalancing support:
- **Portfolio Rebalancing**: Automatically calculates required buy/sell quantities to achieve target allocation percentages
- **Confidence-Weighted Allocations**: LLM-provided confidence scores influence allocation sizes and risk management
- **Multi-Asset Support**: Handles both stock positions and prediction market outcomes within unified portfolio framework
- **Rebalance Execution**: Multiple trades executed atomically during single rebalancing operation
- **Performance Tracking**: Unrealized P&L calculated using current market prices and allocation percentages
- **Isolated Accounts**: Each agent maintains dedicated account for comparative performance analysis
- **Context-Aware Decisions**: Current allocation percentages and portfolio status provided to LLM for informed decision making
- **Portfolio Models**: Structured data models for allocation targets, rebalance plans, and portfolio summaries

### Trading System Integration
- **Native .run() Methods**: Backend uses StockTradingSystem.run() and PolymarketTradingSystem.run() methods
- **Concurrent Execution**: Stock and polymarket systems run in parallel threads
- **Portfolio-Wide Decisions**: Each .run() call makes single portfolio allocation decision instead of individual stock decisions
- **Background Loop**: 30-minute intervals between system runs for live trading
- **Market Hours Restriction**: Stock trading only executes during weekdays and market hours (9:30 AM - 4:00 PM ET)
- **Polymarket 24/7**: Polymarket trading continues around the clock since prediction markets operate continuously

### Frontend State Management
React components use hooks for state management with automatic refresh intervals:
- News: Refreshes every hour
- Models: Refreshes daily
- Social: Refreshes daily
- System logs: Real-time updates

## Key Files to Understand

- **`examples/fetcher_demo.py`**: Comprehensive examples of all fetcher types
- **`trading_bench/agents/base_agent.py`**: Unified base agent class with LLM integration and portfolio management
- **`trading_bench/agents/stock_agent.py`**: Portfolio allocation trading implementation with StockTradingSystem
- **`trading_bench/agents/polymarket_agent.py`**: Polymarket portfolio trading implementation with PolymarketTradingSystem
- **`trading_bench/accounts/base_account.py`**: Core account management with portfolio rebalancing logic
- **`trading_bench/accounts/portfolio_models.py`**: Portfolio data models for allocations and rebalancing
- **`backend/app/data.py`**: Bridge between FastAPI and trading_bench library
- **`backend/app/trading_system.py`**: Multi-asset trading system using native .run() methods with portfolio support
- **`backend/app/routers/models.py`**: API endpoints including portfolio data access
- **`frontend/src/components/Portfolio.tsx`**: Portfolio visualization component with real-time updates
- **`frontend/src/App.tsx`**: Main routing and layout structure

## API Development Notes

When adding new endpoints:
1. Add route to appropriate router in `backend/app/routers/`
2. Add corresponding real data function in `backend/app/data.py`
3. Ensure proper error handling for missing API credentials
4. Follow pattern of returning empty results rather than fake data when APIs unavailable

### Portfolio API Endpoints
- **`GET /api/models/{model_id}/portfolio`**: Get portfolio data for specific model (stock or polymarket)
- **Portfolio data includes**: cash balance, holdings, positions, allocation percentages, P&L metrics
- **Model ID format**: `{base_model_id}_{category}` (e.g., `gpt-4o_stock`, `claude-3.7-sonnet_polymarket`)
- **Real-time support**: Portfolio endpoints provide both historical and real-time market data when available

## Frontend Development Notes

When adding new components:
1. Follow existing patterns for data fetching with error handling
2. Use consistent styling with existing components
3. Add loading states and error boundaries
4. Implement proper TypeScript interfaces for API responses
